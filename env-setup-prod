#!/bin/bash

# Production Environment Setup Script for CloudSynk
# This script sets up a secure production environment

export BASE_DIR=${PWD}/
export DJANGO_ENV="production"

# Source Azure credentials (critical for Azure Blob Storage)
source ../.bashrc
source ../az_intf

# Set production environment variables
export DEBUG=false
export DJANGO_DEBUG=false


export DJANGO_SECRET_KEY=$DJANGO_SECRET_KEY 

# External IP Configuration
export EXTERNAL_IP=${EXTERNAL_IP}
# Default NGINX port is already set by start-prod.sh; fallback for env
export NGINX_PORT=${NGINX_PORT:-80}
export SERVER_NAME=${SERVER_NAME:-"localhost"}

# ALLOWED_HOSTS: add production hosts if not explicitly set
if [ -z "$ALLOWED_HOSTS" ]; then
    # Include external IP, hostname, and both www/non-www domains
    ALLOWED_HOSTS_LIST=("localhost" "127.0.0.1" "ubuntu-24")
    if [ -n "$EXTERNAL_IP" ]; then
        ALLOWED_HOSTS_LIST+=("$EXTERNAL_IP")
    fi
    ALLOWED_HOSTS_LIST+=("www.cloudsynk.org.in" "cloudsynk.org.in")
    export ALLOWED_HOSTS=$(IFS=,; echo "${ALLOWED_HOSTS_LIST[*]}")
fi

# CSRF Trusted Origins - Update with your production domains and ports
CSRF_BASE_ORIGINS=("https://${EXTERNAL_IP}:${NGINX_PORT}" "http://${EXTERNAL_IP}:${NGINX_PORT}" "https://localhost:${NGINX_PORT}" "http://localhost:${NGINX_PORT}" "https://www.cloudsynk.org.in:${NGINX_PORT}" "https://cloudsynk.org.in:${NGINX_PORT}" "http://www.cloudsynk.org.in:${NGINX_PORT}" "http://cloudsynk.org.in:${NGINX_PORT}")
# Also add common ports 80/443 for external access
CSRF_BASE_ORIGINS+=("https://${EXTERNAL_IP}:443" "http://${EXTERNAL_IP}:80" "https://www.cloudsynk.org.in:443" "http://www.cloudsynk.org.in:80" "https://cloudsynk.org.in:443" "http://cloudsynk.org.in:80")
export CSRF_TRUSTED_ORIGINS=$(IFS=,; echo "${CSRF_BASE_ORIGINS[*]}")

export SECURE_SSL_REDIRECT=true
export SESSION_COOKIE_SECURE=true
export CSRF_COOKIE_SECURE=true

# Production logging
export LOG_LEVEL="WARNING"
export DJANGO_LOG_LEVEL="WARNING"

# Security headers
export SECURE_BROWSER_XSS_FILTER=true
export SECURE_CONTENT_TYPE_NOSNIFF=true
export X_FRAME_OPTIONS="DENY"

# Database settings (should use external DB in production)
export DATABASE_URL=""  # SET TO PRODUCTION DATABASE

echo "=== CloudSynk Production Environment Setup ==="
echo "‚ö†Ô∏è  SECURITY CHECKLIST BEFORE PROCEEDING:"
echo ""
echo "1. ‚úÖ Set DJANGO_SECRET_KEY from secure source (not hardcoded)"
echo "2. ‚úÖ Update ALLOWED_HOSTS with your production domain"
echo "3. ‚úÖ Configure production database (not SQLite)"
echo "4. ‚úÖ Set up HTTPS/SSL certificates"
echo "5. ‚úÖ Configure Azure Key Vault for secrets"
echo "6. ‚úÖ Set up monitoring and logging"
echo "7. ‚úÖ Review firewall and network security"
echo ""

# Validate critical environment variables
if [ -z "$DJANGO_SECRET_KEY" ]; then
    echo "‚ùå ERROR: DJANGO_SECRET_KEY not set!"
    echo "   Generate with: python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())'"
    echo "   Store securely and set as environment variable"
    exit 1
fi

# Check if Python version file exists and clean up
if [ -f "python_version.tmp" ]; then
    rm -rf python_version.tmp
fi

# Create and activate virtual environment
python3 -m venv .storage-env-prod
source .storage-env-prod/bin/activate

python3 --version > python_version.tmp
echo "‚úÖ Python version checked"
rm -rf python_version.tmp

# Validate virtual environment
if [ -f venv.tmp ]; then
    rm -rf venv.tmp
fi

echo "$VIRTUAL_ENV" | sed -e 's/\/.*\///g' > venv.tmp
if [ ! -s venv.tmp ]; then
    echo "‚ùå FAILED: Virtual env not installed"
    echo "To install virtual env run: apt install python3.8-venv"
    exit 1
fi

# Install system dependencies for Python packages
echo "üîß Installing system dependencies..."
if command -v apt-get >/dev/null 2>&1; then
    # Check if we need to install MySQL client dependencies
    if ! command -v pkg-config >/dev/null 2>&1 || ! pkg-config --exists mysqlclient 2>/dev/null; then
        echo "üì¶ Installing MySQL client development packages..."
        if command -v sudo >/dev/null 2>&1; then
            sudo apt-get update -qq
            sudo apt-get install -y pkg-config python3-dev default-libmysqlclient-dev build-essential
        else
            echo "‚ùå Need sudo access to install system packages:"
            echo "   sudo apt-get install pkg-config python3-dev default-libmysqlclient-dev build-essential"
            exit 1
        fi
    fi
else
    echo "‚ö†Ô∏è  Non-Debian system detected. Ensure these packages are installed:"
    echo "   - pkg-config"
    echo "   - mysql-devel (or equivalent)"
    echo "   - python3-dev"
    echo "   - build tools (gcc, make)"
fi

# Install production dependencies
if [ "storage-env-prod" != "$(cat venv.tmp)" ]; then
    source ${BASE_DIR}/.storage-env-prod/bin/activate
    
    # Install production requirements with security updates
    python3 -m pip install --upgrade pip
    
    # Install build dependencies first (required for packages like numpy)
    echo "üì¶ Installing build dependencies (setuptools, wheel)..."
    python3 -m pip install --upgrade setuptools wheel
    
    echo "üì¶ Installing Python packages from requirements-prod.txt..."
    python3 -m pip install -r requirements-prod.txt
    
    # Install additional production packages
    # python3 -m pip install gunicorn whitenoise django-environ psycopg2-binary
fi
rm -rf venv.tmp

export PYTHONPATH=${PWD}/../:$PYTHONPATH

echo "‚úÖ Production Virtual Environment activated"

# Simple arg parsing
NO_NODE=0
for arg in "$@"; do
    case "$arg" in
        --no-node)
            NO_NODE=1
            ;;
        --help|-h)
            echo "Usage: source env-setup-prod [--no-node]"
            echo ""
            echo "Production environment setup for CloudSynk"
            echo "Requires proper configuration of environment variables"
            return 0 2>/dev/null || exit 0
            ;;
    esac
done

# Handle Node.js dependencies for production
if [ -f package.json ]; then
    if [ "$NO_NODE" = "1" ]; then
        echo "‚è≠Ô∏è  SKIPPING: Node dependency installation (--no-node)"
    else
        if command -v npm >/dev/null 2>&1; then
            echo "üì¶ Installing production frontend dependencies..."
            export NODE_ENV=production
            
            if [ -f package-lock.json ]; then
                echo "Using package-lock.json -> running: npm ci --production"
                npm ci --production || echo "npm ci failed. Check manually."
            else
                echo "No package-lock.json found -> running: npm install --production"
                npm install --production || echo "npm install failed. Check manually."
            fi
            
            # Build production assets if build script exists
            if npm run | grep -q "build"; then
                echo "üî® Building production assets..."
                npm run build || echo "Build failed. Check manually."
            fi
        else
            echo "‚ùå npm not available. Install Node.js for production asset building."
            exit 1
        fi
    fi
fi

# Final production checks
echo ""
echo "üîç PRODUCTION READINESS CHECKS:"
echo ""

# Check Django settings
if python3 -c "import os; os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'storage_webapp.settings_prod'); from django.conf import settings; print('‚úÖ Django settings loaded')" 2>/dev/null; then
    echo "‚úÖ Django production settings accessible"
else
    echo "‚ùå Django production settings not found or invalid"
    echo "   Create storage_webapp/settings_prod.py for production"
fi

# Check critical directories
if [ ! -d "static" ]; then
    echo "‚ö†Ô∏è  Static files directory not found - run collectstatic"
fi

if [ ! -d "media" ]; then
    mkdir -p media
    echo "‚úÖ Created media directory"
fi

sudo sqlite3 db.sqlite3 "PRAGMA journal_mode=WAL;"
sudo sqlite3 db.sqlite3 "PRAGMA synchronous=NORMAL;"

echo ""
echo "üöÄ NEXT STEPS FOR PRODUCTION DEPLOYMENT:"
echo "1. python manage.py check --deploy"
echo "2. python manage.py collectstatic"
echo "3. python manage.py migrate"
echo "4. Set up reverse proxy (nginx/Apache)"
echo "5. Configure SSL certificates"
echo "6. Set up monitoring and backups"
echo ""
echo "‚úÖ PRODUCTION ENVIRONMENT READY"
echo "‚ö†Ô∏è  Remember: Test thoroughly before going live!"
