{% extends 'main/base.html' %}
{% load static %}

{% block title %}Verify Login OTP - CloudSynk{% endblock %}

{% block extra_css %}
<style>
  .otp-card { 
    backdrop-filter: blur(10px); 
    background: rgba(255,255,255,0.95); 
    box-shadow: 0 25px 45px rgba(0,0,0,0.1); 
  }
  .error { 
    color: red; 
  }
  .success {
    color: green;
  }
  .otp-input {
    transition: all 0.3s ease;
  }
  .otp-input:focus {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }
  .btn-primary {
    background: linear-gradient(135deg, #174ea6 0%, #4285f4 100%);
    transition: all 0.3s ease;
  }
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 25px rgba(23, 78, 166, 0.4);
  }
  .btn-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    transition: all 0.3s ease;
  }
  .btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 25px rgba(108, 117, 125, 0.4);
  }
  .info-box {
    background: rgba(66, 133, 244, 0.1);
    border-left: 4px solid #4285f4;
  }
  .loading-spinner {
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md relative z-10">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="mb-4">
        <span class="brand-text navbar-brand">Cloud</span>
        <span class="brand-text navbar-brand-accent">Synk</span>
      </div>
      <p class="text-white text-lg opacity-90">Verify Your Login</p>
    </div>

    <!-- OTP Card -->
    <div class="otp-card rounded-2xl p-8">
      <!-- Info Box -->
      <div class="info-box p-4 rounded-lg mb-6">
        <p class="text-sm text-gray-700">
          <i class="fas fa-info-circle mr-2"></i>
          We've sent a 6-digit verification code to your registered email address. Please enter it below to complete your login.
        </p>
      </div>

      <!-- Alert Container -->
      <div id="alert" class="mb-4 hidden text-center"></div>

      <!-- OTP Form -->
      <form id="otp-form">
        {% csrf_token %}
        <input type="hidden" name="login_otp_id" id="login_otp_id" value="{{ login_otp_id }}">
        
        <div class="mb-6">
          <label for="code" class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-key mr-2 text-gray-400"></i>Verification Code
          </label>
          <input 
            type="text" 
            name="code" 
            id="code" 
            required 
            placeholder="Enter 6-digit OTP"
            maxlength="6"
            pattern="[0-9]{6}"
            class="otp-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-2xl tracking-widest"
          >
          <p class="text-xs text-gray-500 mt-2">
            <i class="fas fa-clock mr-1"></i>Code expires in 10 minutes
          </p>
        </div>

        <!-- Attempts Counter -->
        <div id="attempts-info" class="mb-4 text-sm text-gray-600 text-center hidden">
          <i class="fas fa-exclamation-triangle mr-1"></i>
          <span id="attempts-text"></span>
        </div>

        <!-- Verify Button -->
        <button 
          type="submit" 
          id="verify-btn" 
          class="btn-primary w-full py-3 text-white font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed mb-4"
        >
          <span id="verify-text">Verify & Login</span>
          <i id="verify-spinner" class="fas fa-spinner loading-spinner hidden ml-2"></i>
        </button>

        <!-- Resend Button -->
        <button 
          type="button" 
          id="resend-btn" 
          class="btn-secondary w-full py-3 text-white font-medium rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span id="resend-text">Resend Code</span>
          <i id="resend-spinner" class="fas fa-spinner loading-spinner hidden ml-2"></i>
        </button>

        <!-- Resend Info -->
        <div id="resend-info" class="mt-3 text-sm text-gray-600 text-center hidden">
          <i class="fas fa-info-circle mr-1"></i>
          <span id="resend-info-text"></span>
        </div>
      </form>

      <!-- Back to Login -->
      <div class="mt-6 pt-4 border-t border-gray-200 text-center">
        <a href="/login/" class="text-sm text-blue-600 hover:text-blue-800 font-medium transition">
          <i class="fas fa-arrow-left mr-1"></i>Back to Login
        </a>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center mt-8">
      <p class="text-white text-sm opacity-75">
        Â© 2025 CloudSynk. Secure cloud storage for everyone.
      </p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const form = document.getElementById('otp-form');
  const verifyBtn = document.getElementById('verify-btn');
  const verifyText = document.getElementById('verify-text');
  const verifySpinner = document.getElementById('verify-spinner');
  const resendBtn = document.getElementById('resend-btn');
  const resendText = document.getElementById('resend-text');
  const resendSpinner = document.getElementById('resend-spinner');
  const alertBox = document.getElementById('alert');
  const codeInput = document.getElementById('code');
  const attemptsInfo = document.getElementById('attempts-info');
  const attemptsText = document.getElementById('attempts-text');
  const resendInfo = document.getElementById('resend-info');
  const resendInfoText = document.getElementById('resend-info-text');

  let resendTimeout = null;

  function showAlert(message, type = 'error') {
    alertBox.textContent = message;
    alertBox.classList.remove('hidden', 'error', 'success');
    alertBox.classList.add(type);
    setTimeout(() => alertBox.classList.add('hidden'), 5000);
  }

  function setVerifyLoading(isLoading) {
    verifyBtn.disabled = isLoading;
    verifyText.textContent = isLoading ? 'Verifying...' : 'Verify & Login';
    verifySpinner.classList.toggle('hidden', !isLoading);
  }

  function setResendLoading(isLoading) {
    resendBtn.disabled = isLoading;
    resendText.textContent = isLoading ? 'Sending...' : 'Resend Code';
    resendSpinner.classList.toggle('hidden', !isLoading);
  }

  function startResendTimeout(seconds) {
    resendBtn.disabled = true;
    resendInfo.classList.remove('hidden');
    let remaining = seconds;
    
    const updateTimer = () => {
      if (remaining <= 0) {
        resendBtn.disabled = false;
        resendInfo.classList.add('hidden');
        clearInterval(resendTimeout);
      } else {
        resendInfoText.textContent = `Please wait ${remaining}s before resending`;
        remaining--;
      }
    };
    
    updateTimer();
    resendTimeout = setInterval(updateTimer, 1000);
  }

  // Verify OTP
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const code = codeInput.value.trim();
    const login_otp_id = document.getElementById('login_otp_id').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (code.length !== 6) {
      showAlert('Please enter a valid 6-digit OTP');
      return;
    }

    setVerifyLoading(true);

    try {
      const res = await fetch("{% url 'verify_login_otp' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ login_otp_id, code })
      });
      
      const data = await res.json();
      
      if (data.success) {
        showAlert('Login successful! Redirecting...', 'success');
        setTimeout(() => {
          window.location.href = '/home/';
        }, 1000);
      } else {
        showAlert(data.error || 'Verification failed');
        if (data.attempts_left !== undefined) {
          attemptsText.textContent = `${data.attempts_left} attempt(s) remaining`;
          attemptsInfo.classList.remove('hidden');
        }
        setVerifyLoading(false);
        codeInput.value = '';
        codeInput.focus();
      }
    } catch (err) {
      showAlert('An error occurred. Please try again.');
      setVerifyLoading(false);
    }
  });

  // Resend OTP
  resendBtn.addEventListener('click', async () => {
    const login_otp_id = document.getElementById('login_otp_id').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    setResendLoading(true);

    try {
      const res = await fetch("{% url 'resend_login_otp' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ login_otp_id })
      });
      
      const data = await res.json();
      
      if (data.success) {
        showAlert('OTP resent successfully!', 'success');
        startResendTimeout(180); // 3 minutes
      } else {
        showAlert(data.error || 'Failed to resend OTP');
        setResendLoading(false);
      }
    } catch (err) {
      showAlert('An error occurred. Please try again.');
      setResendLoading(false);
    } finally {
      if (!resendBtn.disabled) {
        setResendLoading(false);
      }
    }
  });

  // Auto-focus code input
  codeInput.focus();

  // Only allow numeric input
  codeInput.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
  });

  // Auto-submit when 6 digits are entered
  codeInput.addEventListener('input', (e) => {
    if (e.target.value.length === 6) {
      form.dispatchEvent(new Event('submit'));
    }
  });
</script>
{% endblock %}
