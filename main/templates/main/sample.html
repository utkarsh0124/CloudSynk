{% extends 'main/base.html' %}
{% load static %}

{% block title %}
  CloudSynk - Dashboard
{% endblock %}

{% block body_class %}
  app-background
{% endblock %}

{% block background_pattern %}
  <!-- No background pattern for clean theme -->
{% endblock %}

{% block content %}
  <!-- Navigation Bar -->
  <nav class="flex justify-between px-4 py-4 bg-gray-100 shadow-sm">
    <div class="flex items-center ml-4">
      <!-- Logo -->
      <!-- Mobile nav toggle -->
      <button id="nav-toggle-btn" class="block sm:hidden mr-4 text-gray-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
      <!-- Logo for desktop -->
      <span class="hidden sm:inline-block brand-text navbar-brand">Cloud</span>
      <span class="hidden sm:inline-block brand-text navbar-brand-accent ml-1">Synk</span>
    </div>
    <div>
      <!-- Search Bar -->
      <form action="#" method="get" class="flex items-center bg-white rounded-full shadow px-3 py-1 w-72 focus-within:ring-2 focus-within:ring-blue-400 transition">
        <input type="text" name="q" placeholder="Search files..." class="flex-grow bg-transparent outline-none text-gray-700 px-2 py-1" autocomplete="off" />
        <button type="submit" class="text-blue-500 hover:text-blue-700 transition"><i class="fas fa-search"></i></button>
      </form>
    </div>

    <div class="relative">
      <div id="menu-toggle" class="cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="w-6 h-6 my-2">
          <path d="M0 96C0 78.3 14.3 64 32 64l384 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 128C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32l384 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 288c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32L32 448c-17.7 0-32-14.3-32-32s14.3-32 32-32l384 0c17.7 0 32 14.3 32 32z" />
        </svg>
      </div>
      <div id="dropdown-menu" class="dropdown-menu bg-white shadow rounded py-2 right-0 mt-2 absolute min-w-[100px]" style="min-width: 80px !important; width: 100px !important; font-size: 0.95rem !important; padding: 0.25rem 0 !important; top: 60%; display: none; transition: all 0.3s ease-in-out;">
        <form action="{% url 'logout' %}" method="post" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="block px-6 py-2 text-gray-700 hover:bg-gray-100 bg-transparent border-0" style="padding-top: 0.25rem !important; padding-bottom: 0.25rem !important; font-size: 0.95rem !important;">Logout</button>
        </form>
        {% comment %} <form action="{% url 'deactivate' %}" method="post" style="display:inline; margin-top: 2px;">
          {% csrf_token %}
          <button type="button" id="deactivate-btn" class="block px-3 py-2 text-red-600 hover:bg-red-100 bg-transparent border-0" style="padding-top: 0.25rem !important; padding-bottom: 0.25rem !important; font-size: 0.95rem !important;">Deactivate</button>
        </form> {% endcomment %}
      </div>
    </div>
    <!-- Modal for Deactivate Confirmation moved outside dropdown-menu -->
    <div id="deactivate-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full">
        <h2 class="text-lg font-semibold mb-4 text-red-600">Confirm Deactivation</h2>
        <p class="mb-4 text-gray-700">Deactivating your account will permanently remove all your stored data. This action cannot be undone. Are you sure you want to continue?</p>
        <div class="flex justify-end space-x-3">
          <button id="cancel-deactivate" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-700">Cancel</button>
          <button id="confirm-deactivate" class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Yes, Deactivate</button>
        </div>
      </div>
    </div>
    
    <!-- Modal for Delete File Confirmation -->
    <div id="delete-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full">
        <h2 class="text-lg font-semibold mb-4 text-red-600">Confirm Delete</h2>
        <p class="mb-4 text-gray-700">Are you sure you want to delete "<span id="delete-filename" class="font-medium"></span>"? This action cannot be undone.</p>
        <div class="flex justify-end space-x-3">
          <button id="cancel-delete" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-700">Cancel</button>
          <button id="confirm-delete" class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Yes, Delete</button>
        </div>
      </div>
    </div>

    <!-- Storage Quota Exceeded Modal -->
    <div id="quota-exceeded-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
        <h2 class="text-lg font-semibold mb-4 text-orange-600 flex items-center">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          Storage Quota Exceeded
        </h2>
        <div class="mb-4">
          <p class="text-gray-700 mb-3" id="quota-error-message">
            You don't have enough storage space to upload this file.
          </p>
          <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-3">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Current Usage:</span>
              <span class="font-medium text-gray-800" id="quota-current-usage">{{ user.userinfo.storage_used_bytes|filesizeformat }}</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Storage Limit:</span>
              <span class="font-medium text-gray-800" id="quota-storage-limit">{{ user.userinfo.storage_quota_bytes|filesizeformat }}</span>
            </div>
            <div class="flex justify-between text-sm mt-2 pt-2 border-t border-orange-200">
              <span class="text-gray-600">File Size:</span>
              <span class="font-medium text-orange-600" id="quota-file-size">-</span>
            </div>
          </div>
          {% comment %} <p class="text-sm text-gray-600">
            To upload this file, please delete some existing files or 
            <span class="text-blue-600 font-medium cursor-pointer hover:underline" id="upgrade-subscription-link">upgrade your subscription</span>.
          </p> {% endcomment %}
        </div>
        <div class="flex justify-end space-x-3">
          {% comment %} <button id="quota-manage-files" class="px-4 py-2 rounded bg-blue-100 hover:bg-blue-200 text-blue-700 transition-colors">
            <i class="fas fa-folder-open mr-1"></i>
            Manage Files
          </button> {% endcomment %}
          <button id="quota-modal-close" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-700 transition-colors">Close</button>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden transition-all duration-300">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-lg w-full mx-4 transform transition-all duration-300">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-semibold text-gray-800">Profile Settings</h2>
          <button id="close-settings" class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <!-- Profile Information Section -->
        <div class="mb-6">
          <h3 class="text-lg font-medium text-gray-700 mb-4">Account Information</h3>
          <div class="space-y-3">
            <div class="flex justify-between py-2 border-b border-gray-100 rounded px-2">
              <span class="text-gray-600">Username:</span>
              <span class="font-medium text-gray-800">{{ user.username }}</span>
            </div>
            <div class="flex justify-between py-2 border-b border-gray-100 rounded px-2">
              <span class="text-gray-600">Email:</span>
              <span class="font-medium text-gray-800">{{ user.email|default:'Not provided' }}</span>
            </div>
            <div class="flex justify-between py-2 border-b border-gray-100 rounded px-2">
              <span class="text-gray-600">Subscription:</span>
              <span class="font-medium text-blue-600">{{ user.userinfo.subscription_type|default:'Free' }}</span>
            </div>
            <div class="flex justify-between py-2 border-b border-gray-100 rounded px-2">
              <span class="text-gray-600">Storage Used:</span>
              <span class="font-medium text-gray-800">{{ user.userinfo.storage_used_bytes|filesizeformat|default:'0 bytes' }} / {{ user.userinfo.storage_quota_bytes|filesizeformat|default:'5 GB' }}</span>
            </div>
            <div class="flex justify-between py-2 rounded px-2">
              <span class="text-gray-600">Member Since:</span>
              <span class="font-medium text-gray-800">{{ user.date_joined|date:'F Y' }}</span>
            </div>
          </div>
        </div>
        
        <!-- Storage Usage Progress Bar -->
        {% if user.userinfo.storage_quota_bytes %}
        <div class="mb-6">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-600">Storage Usage</span>
            <span class="text-sm text-gray-500">{{ user.userinfo.storage_used_bytes|filesizeformat }} of {{ user.userinfo.storage_quota_bytes|filesizeformat }}</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            {% widthratio user.userinfo.storage_used_bytes user.userinfo.storage_quota_bytes 100 as usage_percent %}
            <div class="bg-blue-500 h-2 rounded-full storage-progress" style="width: {{ usage_percent|default:0 }}%"></div>
          </div>
        </div>
        {% endif %}
        
        <!-- Action Buttons -->
        <div class="flex justify-between space-x-3">
          <button id="settings-deactivate-btn" class="px-4 py-2 rounded bg-red-100 hover:bg-red-200 text-red-700 transition-colors">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            Deactivate Account
          </button>
          <div class="space-x-3">
            <button id="close-settings-bottom" class="px-4 py-2 rounded bg-blue-500 hover:bg-blue-600 text-white transition-colors">Close</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- About Modal -->
    <div id="about-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden transition-all duration-300">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4 transform transition-all duration-300">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-semibold text-gray-800">About CloudSynk</h2>
          <button id="close-about" class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <!-- About Content -->
        <div class="mb-6">
          <div class="flex items-center justify-center mb-4">
            <div class="flex items-center">
              <span class="brand-text navbar-brand">Cloud</span>
              <span class="brand-text navbar-brand-accent ml-1">Synk</span>
            </div>
          </div>
          
          <p class="text-gray-700 text-center mb-6 leading-relaxed">
            CloudSynk lets you easily store, access, and manage your files online, keeping them secure and available anytime, anywhere across devices.
          </p>
          
          <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <h3 class="text-lg font-medium text-gray-800 mb-2 flex items-center">
              <i class="fab fa-github text-gray-600 mr-2"></i>
              Open Source Project
            </h3>
            <p class="text-gray-600 text-sm mb-3">
              CloudSynk is an open source project. View the code, contribute, or report issues on GitHub.
            </p>
            <a href="https://github.com/utkarsh0124/CloudSynk" target="_blank" 
               class="inline-flex items-center px-3 py-2 bg-gray-800 hover:bg-gray-900 text-white text-sm rounded-md transition-colors">
              <i class="fab fa-github mr-2"></i>
              View on GitHub
              <i class="fas fa-external-link-alt ml-2 text-xs"></i>
            </a>
          </div>
        </div>
        
        <!-- Close Button -->
        <div class="flex justify-end">
          <button id="close-about-bottom" class="px-4 py-2 rounded bg-blue-500 hover:bg-blue-600 text-white transition-colors">
            Close
          </button>
        </div>
      </div>
    </div>
  </nav>

  <div class="flex" style="height: calc(100vh - 80px);">
    <!-- Left Side Panel Navigation -->
    <div id="side-nav" class="fixed inset-y-0 left-0 z-30 w-64 bg-white shadow-lg border-r border-gray-200 transform -translate-x-full transition-transform duration-500 ease-in-out sm:static sm:translate-x-0 sm:flex">
      <!-- App logo inside side-nav (mobile only) -->
      <div class="flex items-center px-10 py-4 block sm:hidden">
        <span class="brand-text navbar-brand">Cloud</span>
        <span class="brand-text navbar-brand-accent ml-1">Synk</span>
      </div>
      <div class="flex flex-col sm:py-6 px-4 sm:px-2 space-y-1">
        <!-- Profile Card -->
        <div class="w-56 bg-gray-50 rounded-2xl shadow p-2 mb-4 flex flex-col justify-center" style="height: 160px;">
          <div class="flex items-center ml-1 mr-1" style="margin-bottom: 8px; margin-top: -8px;">
            <img src="https://api.dicebear.com/9.x/initials/svg?seed={{ user_info.user_name }}" alt="Profile" class="w-16 h-16 rounded-full object-cover mr-4" />
            <span class="font-semibold text-gray-800 text-xl">{{ user_info.user_name }}</span>
          </div>
          <!-- Storage Status Bar -->
          <div class="flex flex-col mt-2 ml-1 mr-2">
            <div class="text-xs text-gray-500 mb-1">
              <div>Storage Used</div>
              <div class="font-medium text-gray-800">{{ user_info.storage_used_bytes|filesizeformat }} / {{ user_info.storage_quota_bytes|filesizeformat }}</div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2" id="storage-container" data-used="{{ user_info.storage_used_bytes }}" data-quota="{{ user_info.storage_quota_bytes }}">
              <div id="storage-bar" class="bg-blue-500 h-2 rounded-full" style="width:0%" title="Storage usage"></div>
            </div>
          </div>
        </div>

        <button id="transfer-manager-btn" class="flex items-center space-x-1 text-gray-700 hover:text-blue-600 hover:bg-blue-50 hover:border-blue-200 transition mt-auto ml-1 py-2 rounded-2xl border border-transparent hover:shadow-sm active:bg-blue-100 active:border-blue-300">
          <i class="fas fa-exchange-alt text-xl ml-4"></i>
          <span>Transfers</span>
        </button>
        {% comment %}
        <button id="history-btn" class="flex items-center space-x-1 text-gray-700 hover:text-blue-600 hover:bg-blue-50 hover:border-blue-200 transition mt-auto ml-1 py-2 rounded-2xl border border-transparent hover:shadow-sm active:bg-blue-100 active:border-blue-300">
          <i class="fas fa-history text-xl ml-4"></i>
          <span>History</span>
        </button>
        {% endcomment %}
        <button id="settings-btn" class="flex items-center space-x-1 text-gray-700 hover:text-blue-600 hover:bg-blue-50 hover:border-blue-200 transition mt-auto ml-1 py-2 rounded-2xl border border-transparent hover:shadow-sm active:bg-blue-100 active:border-blue-300">
          <i class="fas fa-cog text-xl ml-4"></i>
          <span>Settings</span>
        </button>
        <button id="about-btn" class="flex items-center space-x-1 text-gray-700 hover:text-blue-600 hover:bg-blue-50 hover:border-blue-200 transition mt-auto ml-1 py-2 rounded-2xl border border-transparent hover:shadow-sm active:bg-blue-100 active:border-blue-300">
          <i class="fas fa-info-circle text-xl ml-4"></i>
          <span>About</span>
        </button>
      </div>
    </div>

    <!-- Scrollable Main Content Area -->
    <div class="flex-1 overflow-y-auto bg-gray-50 p-8">
      <div class="flex justify-between mb-6 items-center">
        <!-- View Toggle Buttons - Left side -->
        <div class="flex items-center space-x-2">
          <button id="list-view-btn" type="button" class="bg-gray-200 hover:bg-blue-500 hover:text-white text-gray-700 px-3 py-2 rounded transition flex items-center" title="List View"><i class="fas fa-list"></i></button>
          <button id="tile-view-btn" type="button" class="bg-gray-200 hover:bg-blue-500 hover:text-white text-gray-700 px-3 py-2 rounded transition flex items-center" title="Tile View"><i class="fas fa-th-large"></i></button>
        </div>

        <!-- Upload Form - Right side -->
        <form id="upload-form" enctype="multipart/form-data" class="relative">
          {% csrf_token %}
          <label for="file-upload" class="flex items-center w-24 space-x-1 text-gray-700 hover:text-white hover:bg-blue-500 transition mt-auto ml-1 py-2 rounded-3xl border-2 border-blue-200 border-transparent hover:border-0 hover:shadow-sm active:bg-blue-100">
            <span class="ml-5">Upload</span>
            <input id="file-upload" name="blob_file" type="file" class="hidden" />
          </label>
        </form>
      </div>

      <div id="file-list-container" class="">
        {% for file in blobs %}
          <!-- Tile View -->
          <div class="bg-white rounded-lg shadow p-3 sm:p-4 flex flex-col file-item-tile" style="display: none;">
            <div class="flex items-center mb-2">
              <i class="file-icon text-blue-500 text-xl sm:text-2xl mr-2 sm:mr-3 flex-shrink-0" data-filename="{{ file.blob_name }}"></i>
              <span class="font-medium text-gray-800 truncate-name text-sm sm:text-base" title="{{ file.blob_name }}">{{ file.blob_name|slice:':-4' }}</span>
            </div>
            <div class="text-xs text-gray-500 mb-1">{{ file.blob_size|filesizeformat }}</div>
            <div class="text-xs text-gray-400 mb-2 sm:mb-0">{{ file.blob_uploaded_at_formatted|default:'Unknown date' }}</div>
            <div class="flex items-center mt-2 space-x-2 sm:space-x-3">
              <button class="file-download-btn text-blue-600 hover:underline p-2 sm:p-0 flex items-center bg-transparent border-0 rounded-md sm:rounded-none hover:bg-blue-50 sm:hover:bg-transparent transition-colors" 
                      type="button" 
                      data-blob-id="{{ file.blob_id }}"
                      data-blob-name="{{ file.blob_name }}"
                      data-blob-size="{{ file.blob_size }}"
                      >
                <i class="fas fa-download text-lg sm:text-sm mr-0 sm:mr-1"></i>
                <span class="hidden sm:inline text-xs sm:text-sm ml-1 sm:ml-0">Download</span>
              </button>
              <button class="file-delete-btn text-red-600 hover:underline p-2 sm:p-0 flex items-center bg-transparent border-0 rounded-md sm:rounded-none hover:bg-red-50 sm:hover:bg-transparent transition-colors" 
                      type="button" 
                      data-blob-id="{{ file.blob_id }}">
                <i class="fas fa-trash-alt text-lg sm:text-sm mr-0 sm:mr-1"></i>
                <span class="hidden sm:inline text-xs sm:text-sm ml-1 sm:ml-0">Delete</span>
              </button>
            </div>
          </div>
          
          <!-- List View -->
          <div class="bg-white rounded-lg shadow p-3 flex items-center justify-between file-item-list mb-2">
            <div class="flex items-center flex-1">
              <i class="file-icon text-blue-500 text-lg mr-3" data-filename="{{ file.blob_name }}"></i>
              <div class="flex-1">
                <div class="font-medium text-gray-800 truncate-name" title="{{ file.blob_name }}">{{ file.blob_name|slice:':-4' }}</div>
                <div class="text-xs text-gray-500">{{ file.blob_size|filesizeformat }} â€¢ {{ file.blob_uploaded_at_formatted|default:'Unknown date' }}</div>
              </div>
            </div>
            <div class="flex items-center space-x-2">
              <button class="file-download-btn bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-2 rounded-md text-sm flex items-center justify-center transition-colors border-0" 
                      type="button" 
                      data-blob-id="{{ file.blob_id }}"
                      data-blob-name="{{ file.blob_name }}"
                      data-blob-size="{{ file.blob_size }}"
                      title="Download {{ file.blob_name }}">
                <i class="fas fa-download"></i>
              </button>
              <button class="file-delete-btn bg-red-100 hover:bg-red-200 text-red-700 px-2 py-2 rounded-md text-sm flex items-center justify-center transition-colors border-0" 
                      type="button" 
                      data-blob-id="{{ file.blob_id }}"
                      title="Delete {{ file.blob_name }}">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </div>
        {% empty %}
          <div class="col-span-full text-center text-gray-400">No files uploaded yet.</div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  {% comment %}
  <script src="{% static 'js/historyManager.js' %}"></script>
  {% endcomment %}
  <script src="{% static 'js/transferManager.js' %}"></script>
  <script src="{% static 'js/index.js' %}"></script>
{% endblock %}
